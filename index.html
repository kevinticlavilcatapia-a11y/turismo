<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Agencia v9 - Edici√≥n y Flexibilidad</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #f39c12; /* Naranja para edici√≥n */
            --success: #27ae60;
            --danger: #c0392b;
            --bg: #f4f6f7;
            --text: #2c3e50;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        
        /* GENERAL UI */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* NAVBAR */
        .navbar { background: var(--primary); padding: 15px 20px; color: white; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-brand { font-weight: bold; font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .nav-menu button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 5px; transition: 0.2s; }
        .nav-menu button:hover, .nav-menu button.active { background: var(--secondary); }

        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e9ecef; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        input, select, textarea { width: 100%; padding: 9px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        input:focus { outline: 2px solid var(--secondary); border-color: transparent; }
        label { display: block; font-size: 0.85em; font-weight: 700; color: #6c757d; margin-bottom: 4px; }

        /* TABLES */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #e9ecef; text-align: left; padding: 12px; font-size: 0.85em; color: #495057; border-bottom: 2px solid #dee2e6; }
        td { padding: 10px; border-bottom: 1px solid #f1f3f5; vertical-align: top; }
        
        /* MARGIN & DISCOUNT CONTROLS */
        .input-group { display: flex; border: 1px solid #ced4da; border-radius: 5px; overflow: hidden; }
        .input-group input { border: none; text-align: right; width: 60%; }
        .input-group select { border: none; background: #e9ecef; width: 40%; text-align: center; border-left: 1px solid #ced4da; font-weight: bold; }

        /* CATALOG */
        .room-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .editing-mode { border: 2px solid var(--accent); } /* Borde naranja cuando se edita */
        
        /* BOTTOM BAR */
        .bottom-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-top: 3px solid var(--secondary); 
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 900; 
        }
        .discount-box { display: flex; align-items: center; gap: 10px; background: #fff3cd; padding: 5px 15px; border-radius: 5px; border: 1px solid #ffeeba; }
        .total-box { text-align: right; }
        .total-amount { font-size: 1.6em; font-weight: 800; color: var(--primary); }

        /* BUTTONS */
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-sm { padding: 5px 10px; font-size: 0.85em; }
        .btn-block { width: 100%; }

        /* PDF TEMPLATE */
        #pdf-template-wrapper { position: absolute; left: -9999px; }
        .pdf-box { width: 800px; background: white; padding: 40px; font-family: 'Helvetica', sans-serif; color: #333; position: relative; }
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        .pdf-client-box { background: #f8f9fa; border-radius: 6px; padding: 15px; margin-bottom: 25px; border: 1px solid #e9ecef; font-size: 13px; }
        .pdf-section-head { font-size: 14px; font-weight: bold; color: var(--secondary); border-bottom: 1px solid #ccc; margin-bottom: 10px; padding-bottom: 5px; margin-top: 20px; text-transform: uppercase; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px; }
        .pdf-table th { text-align: left; background: #f1f3f5; padding: 8px; border-bottom: 1px solid #ccc; }
        .pdf-table td { padding: 10px 8px; border-bottom: 1px solid #eee; }
        .pdf-col-price { text-align: right; font-weight: bold; width: 15%; }
        .pdf-footer-totals { margin-top: 30px; margin-left: auto; width: 250px; }
        .pdf-final-row { display: flex; justify-content: space-between; padding: 10px 0; border-top: 2px solid var(--primary); font-size: 16px; font-weight: bold; color: var(--primary); margin-top: 5px; }

    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-brand">üåé Agencia v9.0</div>
    <div class="nav-menu">
        <button class="active" onclick="switchView('quote')" id="btn-quote">üìù Cotizador</button>
        <button onclick="switchView('dashboard')" id="btn-dashboard">üóÉÔ∏è Historial</button>
        <button onclick="switchView('catalog')" id="btn-catalog">‚öôÔ∏è Cat√°logo</button>
    </div>
</nav>

<div class="container">

    <div id="view-quote" class="view-section active">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>üë§ Datos del Cliente</h3>
                <button class="btn btn-sm btn-danger" onclick="resetQuote()">Limpiar Formulario</button>
            </div>
            <div class="grid-4">
                <div><label>Nombre Completo</label><input type="text" id="q-client" placeholder="Ej. Juan P√©rez"></div>
                <div><label>Nro Pax</label><input type="number" id="q-pax" value="2" min="1" onchange="recalcAll()"></div>
                <div><label>Moneda</label><select id="q-currency" onchange="recalcAll()"><option value="S/">Soles (S/)</option><option value="$">D√≥lares ($)</option></select></div>
                <div><label>Estado</label><select id="q-status"><option value="draft">Borrador</option><option value="sold">Vendida</option></select></div>
            </div>
            <div class="grid-2" style="margin-top:15px;">
                <div><label>Fecha Llegada</label><input type="date" id="q-in-date"></div>
                <div><label>Fecha Retorno</label><input type="date" id="q-out-date"></div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>üå¥ Tours</h3>
                <button class="btn btn-sm btn-success" onclick="addTourRow()">+ Agregar Tour</button>
            </div>
            <div class="table-wrapper">
                <table id="tbl-tours">
                    <thead><tr><th width="40%">Tour</th><th width="15%">Costo (Editable)</th><th width="20%">Ganancia</th><th width="15%">P. Venta</th><th width="10%"></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>üè® Hoteles</h3>
                <button class="btn btn-sm btn-success" onclick="addHotelRow()">+ Agregar Hotel</button>
            </div>
            <div class="table-wrapper">
                <table id="tbl-hotels">
                    <thead><tr><th width="40%">Hotel / Habitaci√≥n</th><th width="10%">Noches</th><th width="15%">Costo Total</th><th width="20%">Ganancia</th><th width="15%">Subtotal</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="card">
            <h3>üóÉÔ∏è Historial de Cotizaciones</h3>
            <div class="table-wrapper">
                <table id="tbl-history">
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Total</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-catalog" class="view-section">
        <div class="grid-2">
            <div class="card" id="cat-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="cat-title">‚ûï Agregar al Cat√°logo</h3>
                    <button id="btn-cancel-edit" class="btn btn-sm btn-danger" style="display:none;" onclick="resetCatForm()">Cancelar Edici√≥n</button>
                </div>
                
                <form onsubmit="saveCatalogItem(event)">
                    <input type="hidden" id="cat-id"> <label>Tipo</label>
                    <select id="cat-type" onchange="toggleCatFields()">
                        <option value="tour">Tour</option>
                        <option value="hotel">Hotel</option>
                    </select>
                    
                    <label style="margin-top:10px;">Nombre</label>
                    <input type="text" id="cat-name" required placeholder="Nombre del Tour o Hotel">

                    <div id="fields-tour">
                        <label style="margin-top:10px;">Costo Base (Por Pax)</label>
                        <input type="number" id="cat-cost" step="0.01">
                    </div>

                    <div id="fields-hotel" style="display:none; margin-top:10px; background:#f1f3f5; padding:10px; border-radius:5px;">
                        <label>Tipos de Habitaci√≥n</label>
                        <div id="room-list-container"></div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addRoomInput()">+ Tipo Habitaci√≥n</button>
                    </div>

                    <label style="margin-top:10px;">Descripci√≥n</label>
                    <textarea id="cat-desc" rows="2"></textarea>
                    
                    <button id="btn-save-cat" class="btn btn-success btn-block" style="margin-top:15px;">Guardar √çtem</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Inventario</h3>
                <div id="catalog-list"></div>
            </div>
        </div>
    </div>

</div>

<div class="bottom-bar" id="quote-bar">
    <div style="display:flex; gap:20px; align-items:center;">
        <div>
            <div style="font-size:0.8em; color:#666;">Utilidad</div>
            <div style="font-weight:bold; color:var(--success)" id="sum-profit">0.00</div>
        </div>
        <div class="discount-box">
            <label style="margin:0; font-size:0.8em;">Descuento Global:</label>
            <input type="number" id="q-discount-val" value="0" style="width:70px; padding:5px; text-align:right;" oninput="recalcAll()">
            <select id="q-discount-type" style="width:50px; padding:5px;" onchange="recalcAll()">
                <option value="%">%</option>
                <option value="$">$</option>
            </select>
        </div>
    </div>
    
    <div style="display:flex; align-items:center; gap:20px;">
        <div class="total-box">
            <div style="font-size:0.8em; color:#666;">TOTAL A PAGAR</div>
            <div class="total-amount" id="sum-total">0.00</div>
        </div>
        <button class="btn btn-primary" onclick="saveQuoteLocally()">Guardar</button>
        <button class="btn btn-success" onclick="generatePDF()">üìÑ PDF</button>
    </div>
</div>

<div id="pdf-template-wrapper">
    <div id="pdf-content" class="pdf-box">
        <div class="pdf-header">
            <div>
                <h1 style="margin:0; color:var(--primary); font-size:24px;">COTIZACI√ìN</h1>
                <div style="font-size:12px; color:#666;">Agencia de Viajes Tarapoto</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:12px;">Fecha</div>
                <strong id="pdf-date"></strong>
            </div>
        </div>

        <div class="pdf-client-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><strong>CLIENTE:</strong> <span id="pdf-client-name"></span></span>
                <span><strong>PAX:</strong> <span id="pdf-pax"></span></span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span><strong>LLEGADA:</strong> <span id="pdf-in"></span></span>
                <span><strong>RETORNO:</strong> <span id="pdf-out"></span></span>
            </div>
        </div>

        <div id="pdf-tours-section">
            <div class="pdf-section-head">Actividades</div>
            <table class="pdf-table">
                <thead><tr><th>Actividad</th><th>Detalle</th><th class="pdf-col-price">Precio</th></tr></thead>
                <tbody id="pdf-tours-body"></tbody>
            </table>
        </div>

        <div id="pdf-hotels-section" style="margin-top:20px;">
            <div class="pdf-section-head">Alojamiento</div>
            <table class="pdf-table">
                <thead><tr><th>Hotel</th><th>Habitaci√≥n</th><th style="text-align:center">Noches</th><th class="pdf-col-price">Total</th></tr></thead>
                <tbody id="pdf-hotels-body"></tbody>
            </table>
        </div>

        <div class="pdf-footer-totals">
            <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0;">
                <span>Subtotal:</span><span id="pdf-subtotal"></span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px; padding:5px 0; color:var(--danger);">
                <span>Descuento:</span><span id="pdf-discount"></span>
            </div>
            <div class="pdf-final-row">
                <span>TOTAL FINAL:</span><span id="pdf-final"></span>
            </div>
        </div>
    </div>
</div>

<script>
    // === BASE DE DATOS ===
    const DB_KEY = 'erp_tpt_v9';
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { tours: [], hotels: [], quotes: [] };
    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    // === GESTI√ìN DE CAT√ÅLOGO (CON EDICI√ìN) ===
    function toggleCatFields() {
        const t = document.getElementById('cat-type').value;
        document.getElementById('fields-tour').style.display = t==='tour'?'block':'none';
        document.getElementById('fields-hotel').style.display = t==='hotel'?'block':'none';
    }

    function addRoomInput(name='', cost='') {
        const div = document.createElement('div');
        div.className = 'room-row';
        div.innerHTML = `<input type="text" placeholder="Tipo (ej. Matrimonial)" class="r-name" value="${name}" required><input type="number" placeholder="Costo" class="r-cost" value="${cost}" required><button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">X</button>`;
        document.getElementById('room-list-container').appendChild(div);
    }

    function saveCatalogItem(e) {
        e.preventDefault();
        const id = document.getElementById('cat-id').value; // ID oculto
        const type = document.getElementById('cat-type').value;
        
        // Crear objeto item
        let item = {
            id: id ? parseInt(id) : Date.now(), // Si hay ID usamos ese, si no, creamos uno nuevo
            type,
            name: document.getElementById('cat-name').value,
            desc: document.getElementById('cat-desc').value
        };

        if(type==='tour'){
            item.cost = parseFloat(document.getElementById('cat-cost').value)||0;
        } else {
            item.rooms=[];
            document.querySelectorAll('#room-list-container .room-row').forEach(row=>{
                item.rooms.push({name:row.querySelector('.r-name').value, cost:parseFloat(row.querySelector('.r-cost').value)||0});
            });
        }

        const list = type==='tour' ? db.tours : db.hotels;
        
        if(id) {
            // MODO EDICI√ìN: Buscar y reemplazar
            const idx = list.findIndex(x => x.id == id);
            if(idx !== -1) list[idx] = item;
            alert('√çtem actualizado correctamente');
        } else {
            // MODO CREACI√ìN: Agregar nuevo
            list.push(item);
            alert('√çtem creado correctamente');
        }
        
        saveDB(); 
        resetCatForm(); 
        renderCatalog(); 
        updateSelects();
    }

    function editItem(type, id) {
        const list = type==='tour' ? db.tours : db.hotels;
        const item = list.find(x => x.id == id);
        if(!item) return;

        // Cargar datos en formulario
        document.getElementById('cat-id').value = item.id;
        document.getElementById('cat-type').value = item.type;
        document.getElementById('cat-name').value = item.name;
        document.getElementById('cat-desc').value = item.desc;
        
        toggleCatFields(); // Asegurar que se ve el campo correcto

        if(type==='tour') {
            document.getElementById('cat-cost').value = item.cost;
        } else {
            document.getElementById('room-list-container').innerHTML = '';
            if(item.rooms) item.rooms.forEach(r => addRoomInput(r.name, r.cost));
        }

        // Cambiar UI para modo edici√≥n
        document.getElementById('cat-card').classList.add('editing-mode');
        document.getElementById('cat-title').innerText = "‚úèÔ∏è Editando: " + item.name;
        document.getElementById('btn-save-cat').innerText = "Actualizar √çtem";
        document.getElementById('btn-save-cat').classList.remove('btn-success');
        document.getElementById('btn-save-cat').classList.add('btn-warning');
        document.getElementById('btn-cancel-edit').style.display = 'block';
        
        // Scroll arriba
        window.scrollTo(0, 0);
    }

    function resetCatForm() {
        document.querySelector('form').reset();
        document.getElementById('cat-id').value = '';
        document.getElementById('room-list-container').innerHTML = '';
        
        // Restaurar UI
        document.getElementById('cat-card').classList.remove('editing-mode');
        document.getElementById('cat-title').innerText = "‚ûï Agregar al Cat√°logo";
        document.getElementById('btn-save-cat').innerText = "Guardar √çtem";
        document.getElementById('btn-save-cat').classList.add('btn-success');
        document.getElementById('btn-save-cat').classList.remove('btn-warning');
        document.getElementById('btn-cancel-edit').style.display = 'none';
    }

    function renderCatalog() {
        const div = document.getElementById('catalog-list'); div.innerHTML='';
        const list = [...db.tours, ...db.hotels];
        list.forEach(i => {
            let info = i.type==='tour' ? `Costo: ${i.cost}` : `Habitaciones: ${i.rooms.length}`;
            div.innerHTML += `
            <div style="border-bottom:1px solid #eee; padding:8px; display:flex; justify-content:space-between; align-items:center;">
                <div><strong>${i.name}</strong> <small>(${i.type}) - ${info}</small></div>
                <div>
                    <button class="btn btn-sm btn-warning" onclick="editItem('${i.type}',${i.id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="delItem('${i.type}',${i.id})">üóëÔ∏è</button>
                </div>
            </div>`;
        });
    }
    
    function delItem(type, id){
        if(!confirm('Borrar?'))return;
        if(type==='tour') db.tours=db.tours.filter(x=>x.id!==id); else db.hotels=db.hotels.filter(x=>x.id!==id);
        saveDB(); renderCatalog(); updateSelects();
    }

    // === COTIZADOR ===
    function getTourOpt() {
        let h='<option value="">-- Tour --</option>';
        db.tours.forEach(t=>h+=`<option value="${t.id}" data-cost="${t.cost}">${t.name}</option>`);
        return h;
    }
    function getHotelOpt() {
        let h='<option value="">-- Hotel --</option>';
        db.hotels.forEach(t=>h+=`<option value="${t.id}">${t.name}</option>`);
        return h;
    }
    function updateSelects(){
        document.querySelectorAll('.item-select').forEach(s=>{ let v=s.value; s.innerHTML=getTourOpt(); s.value=v; });
        document.querySelectorAll('.hotel-select').forEach(s=>{ let v=s.value; s.innerHTML=getHotelOpt(); s.value=v; });
    }

    function addTourRow(d=null) {
        const tr=document.createElement('tr');
        // NOTA: Input cost sin 'readonly' para permitir edici√≥n manual
        tr.innerHTML=`<td><select class="item-select" onchange="fillT(this)">${getTourOpt()}</select></td><td><input type="number" class="cost" value="0" oninput="calc(this)"></td><td><div class="input-group"><input type="number" class="mv" value="20" oninput="calc(this)"><select class="mt" onchange="calc(this)"><option value="%">%</option><option value="$">$</option></select></div></td><td class="row-sub">0.00</td><td><button class="btn btn-sm btn-danger" onclick="delRow(this)">X</button></td>`;
        document.querySelector('#tbl-tours tbody').appendChild(tr);
        if(d){ tr.querySelector('select').value=d.id; tr.querySelector('.cost').value=d.cost; tr.querySelector('.mv').value=d.mv; tr.querySelector('.mt').value=d.mt; calc(tr.querySelector('select')); }
    }
    function fillT(e){ const o=e.options[e.selectedIndex]; if(o.value) e.closest('tr').querySelector('.cost').value=o.dataset.cost; calc(e); }

    function addHotelRow(d=null) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><select class="hotel-select" onchange="loadRooms(this)">${getHotelOpt()}</select><select class="room-select" style="margin-top:5px; display:none;" onchange="fillH(this)"></select></td><td><input type="number" class="qty" value="1" oninput="calc(this)"></td><td><input type="number" class="cost" value="0" oninput="calc(this)"></td><td><div class="input-group"><input type="number" class="mv" value="20" oninput="calc(this)"><select class="mt" onchange="calc(this)"><option value="%">%</option><option value="$">$</option></select></div></td><td class="row-sub">0.00</td><td><button class="btn btn-sm btn-danger" onclick="delRow(this)">X</button></td>`;
        document.querySelector('#tbl-hotels tbody').appendChild(tr);
        if(d){ const hs=tr.querySelector('.hotel-select'); hs.value=d.id; loadRooms(hs, d.rid); tr.querySelector('.qty').value=d.q; tr.querySelector('.cost').value=d.cost; tr.querySelector('.mv').value=d.mv; tr.querySelector('.mt').value=d.mt; calc(hs); }
    }
    
    function loadRooms(sel, savedRoom=null) {
        const h = db.hotels.find(x=>x.id==sel.value);
        const rs = sel.closest('tr').querySelector('.room-select');
        rs.innerHTML='<option value="">-- Habitaci√≥n --</option>';
        if(h && h.rooms){
            h.rooms.forEach(r=>rs.innerHTML+=`<option value="${r.name}" data-cost="${r.cost}">${r.name}</option>`);
            rs.style.display='block';
            if(savedRoom) rs.value=savedRoom;
        } else rs.style.display='none';
    }
    function fillH(e){ const o=e.options[e.selectedIndex]; if(o.value) e.closest('tr').querySelector('.cost').value=o.dataset.cost; calc(e); }

    // CALCULOS
    function calc(e) {
        const tr=e.closest('tr');
        // Obtenemos el costo directamente del input. Como no tiene readonly, el usuario puede cambiarlo
        // y este valor prevalece sobre el cat√°logo.
        const cost=parseFloat(tr.querySelector('.cost').value)||0;
        const mv=parseFloat(tr.querySelector('.mv').value)||0;
        const mt=tr.querySelector('.mt').value;
        const pax=parseFloat(document.getElementById('q-pax').value)||1;
        
        let profit = mt==='%' ? cost*(mv/100) : mv;
        let unit = cost+profit;
        let sub = 0;

        if(tr.closest('table').id.includes('tour')) sub = unit * pax; 
        else sub = unit * (parseFloat(tr.querySelector('.qty').value)||1);

        tr.querySelector('.row-sub').innerText=sub.toFixed(2);
        recalcAll();
    }
    
    function recalcAll() {
        let subtotal = 0;
        let costTotal = 0;
        const pax = parseFloat(document.getElementById('q-pax').value)||1;
        
        // Al recalcular todo (ej. al cambiar Pax), usamos los valores actuales de los inputs.
        // NO reseteamos al precio de cat√°logo. Esto permite la flexibilidad pedida.
        
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr=>{
            // Recalcular fila por si cambi√≥ el pax
            const cost = parseFloat(tr.querySelector('.cost').value)||0;
            const mv = parseFloat(tr.querySelector('.mv').value)||0;
            const mt = tr.querySelector('.mt').value;
            let profit = mt==='%' ? cost*(mv/100) : mv;
            let unit = cost+profit;
            let rowSub = unit * pax;
            
            tr.querySelector('.row-sub').innerText = rowSub.toFixed(2);
            
            subtotal += rowSub;
            costTotal += cost * pax;
        });

        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr=>{
            subtotal += parseFloat(tr.querySelector('.row-sub').innerText)||0;
            costTotal += (parseFloat(tr.querySelector('.cost').value)||0)*(parseFloat(tr.querySelector('.qty').value)||1);
        });

        const discVal = parseFloat(document.getElementById('q-discount-val').value)||0;
        const discType = document.getElementById('q-discount-type').value;
        let discount = discType==='%' ? subtotal*(discVal/100) : discVal;
        
        let finalTotal = subtotal - discount;
        let profit = finalTotal - costTotal;

        const cur = document.getElementById('q-currency').value;
        document.getElementById('sum-profit').innerText = cur+' '+profit.toFixed(2);
        document.getElementById('sum-total').innerText = cur+' '+finalTotal.toFixed(2);
    }
    
    function delRow(b){ b.closest('tr').remove(); recalcAll(); }

    // GUARDAR
    function saveQuoteLocally() {
        const q = {
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            client: document.getElementById('q-client').value,
            total: document.getElementById('sum-total').innerText,
            data: {
                pax: document.getElementById('q-pax').value,
                cur: document.getElementById('q-currency').value,
                dates: [document.getElementById('q-in-date').value, document.getElementById('q-out-date').value],
                discVal: document.getElementById('q-discount-val').value,
                discType: document.getElementById('q-discount-type').value,
                tours: [], hotels: []
            }
        };
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr=>q.data.tours.push({
            id:tr.querySelector('select').value, cost:tr.querySelector('.cost').value, mv:tr.querySelector('.mv').value, mt:tr.querySelector('.mt').value
        }));
        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr=>q.data.hotels.push({
            id:tr.querySelector('.hotel-select').value, rid:tr.querySelector('.room-select').value, q:tr.querySelector('.qty').value, cost:tr.querySelector('.cost').value, mv:tr.querySelector('.mv').value, mt:tr.querySelector('.mt').value
        }));
        db.quotes.push(q); saveDB(); renderHistory(); alert('Guardado');
    }

    function renderHistory() {
        const tb = document.getElementById('history-list'); tb.innerHTML='';
        db.quotes.slice().reverse().forEach(q => {
            tb.innerHTML+=`<tr><td>${q.date}</td><td>${q.client}</td><td>${q.total}</td><td><button class="btn btn-sm btn-primary" onclick="loadQuote(${q.id})">Cargar</button></td></tr>`;
        });
    }

    function loadQuote(id) {
        const q=db.quotes.find(x=>x.id===id); if(!q)return;
        document.getElementById('q-client').value=q.client;
        document.getElementById('q-pax').value=q.data.pax;
        document.getElementById('q-currency').value=q.data.cur;
        document.getElementById('q-in-date').value=q.data.dates[0];
        document.getElementById('q-out-date').value=q.data.dates[1];
        document.getElementById('q-discount-val').value=q.data.discVal||0;
        document.getElementById('q-discount-type').value=q.data.discType||'%';

        document.querySelector('#tbl-tours tbody').innerHTML='';
        q.data.tours.forEach(t=>addTourRow(t));
        document.querySelector('#tbl-hotels tbody').innerHTML='';
        q.data.hotels.forEach(h=>addHotelRow(h));
        
        recalcAll(); switchView('quote');
    }

    function generatePDF() {
        const cur = document.getElementById('q-currency').value;
        const pax = document.getElementById('q-pax').value;

        document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
        document.getElementById('pdf-client-name').innerText = document.getElementById('q-client').value;
        document.getElementById('pdf-pax').innerText = pax;
        document.getElementById('pdf-in').innerText = document.getElementById('q-in-date').value;
        document.getElementById('pdf-out').innerText = document.getElementById('q-out-date').value;

        const tBody = document.getElementById('pdf-tours-body'); tBody.innerHTML='';
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr=>{
            const item = db.tours.find(x=>x.id==tr.querySelector('select').value);
            const sub = tr.querySelector('.row-sub').innerText;
            if(item) tBody.innerHTML+=`<tr><td>${item.name}</td><td>${item.desc || '-'}</td><td class="pdf-col-price">${cur} ${sub}</td></tr>`;
        });

        const hBody = document.getElementById('pdf-hotels-body'); hBody.innerHTML='';
        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr=>{
            const item = db.hotels.find(x=>x.id==tr.querySelector('.hotel-select').value);
            const roomName = tr.querySelector('.room-select').value;
            const nights = tr.querySelector('.qty').value;
            const sub = tr.querySelector('.row-sub').innerText;
            if(item) hBody.innerHTML+=`<tr><td>${item.name}</td><td>${roomName}</td><td style="text-align:center">${nights}</td><td class="pdf-col-price">${cur} ${sub}</td></tr>`;
        });

        let subtotal = 0;
        document.querySelectorAll('.row-sub').forEach(el => subtotal += parseFloat(el.innerText)||0);
        const discVal = parseFloat(document.getElementById('q-discount-val').value)||0;
        const discType = document.getElementById('q-discount-type').value;
        let discountAmt = discType==='%' ? subtotal*(discVal/100) : discVal;

        document.getElementById('pdf-subtotal').innerText = cur + ' ' + subtotal.toFixed(2);
        document.getElementById('pdf-discount').innerText = '- ' + cur + ' ' + discountAmt.toFixed(2);
        document.getElementById('pdf-final').innerText = document.getElementById('sum-total').innerText;

        const el = document.getElementById('pdf-content');
        html2pdf().set({ margin: 10, filename: `Cotizacion_${document.getElementById('q-client').value}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' }}).from(el).save();
    }

    function switchView(v) {
        document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-menu button').forEach(x=>x.classList.remove('active'));
        document.getElementById('btn-'+v).classList.add('active');
        if(v==='quote') document.getElementById('quote-bar').style.display='flex'; else document.getElementById('quote-bar').style.display='none';
        if(v==='dashboard') renderHistory();
    }
    
    function resetQuote(){
        document.querySelectorAll('#view-quote input').forEach(i=>i.value='');
        document.querySelector('#tbl-tours tbody').innerHTML='';
        document.querySelector('#tbl-hotels tbody').innerHTML='';
        document.getElementById('q-pax').value=2;
        recalcAll();
    }

    renderCatalog(); renderHistory();
</script>
</body>
</html>
