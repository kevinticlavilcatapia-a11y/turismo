<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agencia Pro v15 - Finanzas & PDF Oculto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #f39c12;
            --success: #27ae60;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --border: #e9ecef;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', 'Inter', sans-serif; background: #f0f2f5; color: #444; margin: 0; padding-bottom: 140px; }

        /* NAVBAR */
        .navbar { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-menu { display: flex; gap: 8px; }
        .nav-btn { background: transparent; border: 1px solid transparent; color: #666; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .nav-btn.active { background: var(--secondary); color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }

        /* LAYOUT */
        .container { max-width: 1200px; margin: 25px auto; padding: 0 15px; }
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid white; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1.1em; font-weight: 700; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85em; font-weight: 600; color: #7f8c8d; margin-bottom: 6px; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa; }
        input, select, textarea { width: 100%; padding: 10px 15px 10px 35px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fafafa; transition: 0.3s; }
        input:focus, select:focus { background: white; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .no-icon { padding-left: 12px; }

        /* SEARCH BARS */
        .search-box { background: #eef2f5; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .search-box input { background: white; border: 1px solid #ccc; }

        /* ROOM BUILDER */
        .room-builder-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .room-input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .room-list-item { background: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; font-size: 0.9em; }
        .room-tag { font-size: 0.8em; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        
        /* TABLES */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; background: white; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 0.8em; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95em; vertical-align: middle; }
        
        /* CONTROLS */
        .control-group { display: flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .control-group input { border: none; text-align: right; width: 60%; }
        .control-group select { border: none; background: #eee; width: 40%; text-align: center; border-left: 1px solid #ddd; font-weight: bold; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9em; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8em; }

        /* BOTTOM BAR */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 30px; border-top: 1px solid #ddd; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; z-index: 999; }
        .finance-info { display: flex; gap: 20px; align-items: center; }
        .finance-block { text-align: right; }
        .finance-label { font-size: 0.7em; text-transform: uppercase; color: #888; font-weight: 700; }
        .finance-value { font-size: 1.3em; font-weight: 800; color: var(--primary); }
        
        /* Separator for internal vs client numbers */
        .internal-metrics { display: flex; gap: 15px; border-right: 2px solid #eee; padding-right: 20px; margin-right: 10px; }

        /* RESPONSIVE */
        @media (max-width: 1000px) {
            .bottom-bar { flex-direction: column; gap: 15px; align-items: stretch; height: auto; padding-bottom: 25px; }
            .finance-info { flex-wrap: wrap; justify-content: space-between; }
            .internal-metrics { border-right: none; padding-right: 0; width: 100%; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; justify-content: space-around; }
            .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .search-box { flex-direction: column; align-items: stretch; }
        }

        /* PDF HIDDEN */
        #pdf-template-wrapper { position: absolute; left: -9999px; }
        .pdf-box { width: 800px; padding: 40px; background: white; font-family: Helvetica; color: #333; }
        .pdf-header { border-bottom: 3px solid #2c3e50; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px; }
        .pdf-table th { background: #eee; padding: 8px; text-align: left; border-bottom: 2px solid #ccc;}
        .pdf-table td { padding: 8px; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-brand"><i class="fas fa-paper-plane"></i> AgenciaPro v15</div>
    <div class="nav-menu">
        <button class="nav-btn active" onclick="switchView('quote')">Cotizar</button>
        <button class="nav-btn" onclick="switchView('dashboard')">Historial</button>
        <button class="nav-btn" onclick="switchView('catalog')">Catálogo</button>
    </div>
</nav>

<div class="container">

    <div id="view-quote" class="view-section active">
        
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-user-circle"></i> Datos del Viaje</h3>
                <button class="btn btn-sm btn-danger" onclick="resetQuote()"><i class="fas fa-trash"></i> Limpiar</button>
            </div>
            <div class="grid-2">
                <div>
                    <div class="form-group"><label>Cliente</label><div class="input-wrapper"><i class="fas fa-user"></i><input type="text" id="q-client" placeholder="Nombre completo"></div></div>
                    <div class="grid-2">
                         <div class="form-group"><label>Pax</label><div class="input-wrapper"><i class="fas fa-users"></i><input type="number" id="q-pax" value="2" min="1" onchange="recalcAll()"></div></div>
                         <div class="form-group"><label>Moneda</label><div class="input-wrapper"><i class="fas fa-coins"></i><select id="q-currency" onchange="recalcAll()"><option value="S/">Soles</option><option value="$">Dólares</option></select></div></div>
                    </div>
                </div>
                <div>
                    <div class="grid-2">
                        <div class="form-group"><label>Llegada</label><div class="input-wrapper"><i class="fas fa-plane-arrival"></i><input type="date" id="q-in"></div></div>
                        <div class="form-group"><label>Salida</label><div class="input-wrapper"><i class="fas fa-plane-departure"></i><input type="date" id="q-out"></div></div>
                    </div>
                    <div class="form-group"><label>Agente</label><div class="input-wrapper"><i class="fas fa-headset"></i><input type="text" id="q-agent"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-hiking"></i> Tours</h3>
                <button class="btn btn-sm btn-success" onclick="addTourRow()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div class="table-container">
                <table id="tbl-tours">
                    <thead><tr><th width="40%">Actividad</th><th width="20%">Costo Unit.</th><th width="20%">Ganancia</th><th width="15%">P. Venta</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-bed"></i> Hoteles</h3>
                <button class="btn btn-sm btn-success" onclick="addHotelRow()"><i class="fas fa-plus"></i> Agregar</button>
            </div>
            <div class="table-container">
                <table id="tbl-hotels">
                    <thead><tr><th width="40%">Hotel & Habitación</th><th width="10%">Cant/Noches</th><th width="20%">Costo Unit.</th><th width="20%">Ganancia</th><th width="15%">P. Venta</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-history"></i> Historial</h3>
            </div>
            
            <div class="search-box">
                <div class="input-wrapper" style="flex:2;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="hist-search-text" placeholder="Buscar por nombre..." onkeyup="filterHistory()">
                </div>
                <div class="input-wrapper" style="flex:1;">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="hist-date-start" onchange="filterHistory()" title="Desde">
                </div>
                <div class="input-wrapper" style="flex:1;">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="hist-date-end" onchange="filterHistory()" title="Hasta">
                </div>
                <button class="btn btn-sm btn-primary" onclick="filterHistory()"><i class="fas fa-filter"></i> Filtrar</button>
            </div>

            <div class="table-container">
                <table id="tbl-history">
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Total</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-catalog" class="view-section">
        <div class="grid-2">
            <div class="card" id="cat-card">
                <div class="card-header">
                    <h3 class="card-title" id="cat-title"><i class="fas fa-plus-circle"></i> Nuevo Ítem</h3>
                    <button id="btn-cancel-edit" class="btn btn-sm btn-danger" style="display:none;" onclick="resetCatForm()">Cancelar</button>
                </div>
                
                <form onsubmit="saveCatalogItem(event)">
                    <input type="hidden" id="cat-id">
                    
                    <div class="form-group"><label>Tipo</label><div class="input-wrapper"><i class="fas fa-tag"></i><select id="cat-type" onchange="toggleCatFields()"><option value="tour">Tour</option><option value="hotel">Hotel</option></select></div></div>
                    <div class="form-group"><label>Nombre</label><div class="input-wrapper"><i class="fas fa-signature"></i><input type="text" id="cat-name" required></div></div>

                    <div id="fields-tour">
                        <div class="form-group"><label>Costo Base (x Pax)</label><div class="input-wrapper"><i class="fas fa-money-bill"></i><input type="number" id="cat-cost" step="0.01"></div></div>
                    </div>

                    <div id="fields-hotel" style="display:none;">
                        <div class="room-builder-box">
                            <label style="margin-bottom:10px; display:block;">Gestión de Habitaciones</label>
                            
                            <div class="room-input-row">
                                <input type="text" id="r-name" placeholder="Tipo (ej. Doble)" class="no-icon" style="flex:2;">
                                <input type="number" id="r-cap" placeholder="Cap." class="no-icon" style="flex:1;">
                                <input type="number" id="r-cost" placeholder="Costo" class="no-icon" style="flex:1;">
                                <button type="button" class="btn btn-primary" onclick="addTempRoom()"><i class="fas fa-plus"></i></button>
                            </div>
                            
                            <div id="temp-room-list"></div>
                        </div>
                    </div>

                    <button id="btn-save-cat" class="btn btn-success btn-block" style="width:100%; margin-top:15px;"><i class="fas fa-save"></i> Guardar</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list"></i> Inventario</h3>
                </div>
                <div class="search-box" style="padding:10px; margin-bottom:10px;">
                    <div class="input-wrapper" style="width:100%;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="cat-search" placeholder="Buscar tour u hotel..." onkeyup="renderCatalog()">
                    </div>
                </div>

                <div id="catalog-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-bar" id="finance-bar">
    <div class="finance-info">
        
        <div class="internal-metrics">
            <div class="finance-block">
                <div class="finance-label">Costo Neto</div>
                <div class="finance-value" id="disp-cost" style="color:#7f8c8d; font-size:1.1em;">0.00</div>
            </div>
            <div class="finance-block">
                <div class="finance-label">Ganancia</div>
                <div class="finance-value" id="disp-profit" style="color:#27ae60; font-size:1.1em;">0.00</div>
            </div>
        </div>

        <div class="finance-block" style="margin-right: 15px;">
            <div class="finance-label">Total Venta</div>
            <div class="finance-value" id="disp-total">0.00</div>
        </div>
        <div class="finance-block" style="margin-right: 15px;">
            <div class="finance-label">A Cuenta</div>
            <input type="number" id="q-payment" value="0" oninput="recalcAll()" style="width:90px; border:none; border-bottom:1px solid #ccc; text-align:right; font-weight:bold; color:green; font-size:1.1em; background:transparent;">
        </div>
        <div class="finance-block">
            <div class="finance-label">Pendiente</div>
            <div class="finance-value" id="disp-balance" style="color:#e74c3c;">0.00</div>
        </div>
    </div>
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="saveQuote()"><i class="fas fa-save"></i> Guardar</button>
        <button class="btn btn-success" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> PDF</button>
    </div>
</div>

<div id="pdf-template-wrapper">
    <div id="pdf-content" class="pdf-box">
        <div class="pdf-header">
            <div><h1 style="color:#2c3e50; margin:0;">COTIZACIÓN</h1><p style="margin:5px 0;">Agencia de Viajes</p></div>
            <div style="text-align:right; font-size:12px;"><strong>Fecha:</strong> <span id="pdf-date"></span><br><strong>Agente:</strong> <span id="pdf-agent"></span></div>
        </div>
        <div style="background:#f8f9fa; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between; font-size:13px;">
            <div><strong>Cliente:</strong> <span id="pdf-client"></span><br><strong>Pax:</strong> <span id="pdf-pax"></span></div>
            <div style="text-align:right;"><strong>In:</strong> <span id="pdf-in"></span><br><strong>Out:</strong> <span id="pdf-out"></span></div>
        </div>
        
        <div id="pdf-body"></div>

        <div style="margin-left:auto; width:250px; text-align:right; margin-top:20px;">
            <div style="display:flex; justify-content:space-between; padding:5px 0; border-top:1px solid #ddd;"><span>Total:</span> <strong id="pdf-total"></strong></div>
            <div style="display:flex; justify-content:space-between; padding:5px 0; color:green;"><span>A Cuenta:</span> <span id="pdf-paid"></span></div>
            <div style="background:#2c3e50; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between; margin-top:5px;"><span>PENDIENTE:</span> <span id="pdf-bal"></span></div>
        </div>
    </div>
</div>

<script>
    // === BASE DE DATOS ===
    const DB_KEY = 'erp_v14';
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { tours:[], hotels:[], quotes:[] };
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    
    // VARS TEMP
    let tempRooms = [];

    // === CATALOGO (CRUD + BUSCADOR) ===
    function toggleCatFields() {
        const t = document.getElementById('cat-type').value;
        document.getElementById('fields-tour').style.display = t==='tour'?'block':'none';
        document.getElementById('fields-hotel').style.display = t==='hotel'?'block':'none';
    }

    function addTempRoom() {
        const name = document.getElementById('r-name').value;
        const cap = document.getElementById('r-cap').value;
        const cost = document.getElementById('r-cost').value;
        if(!name || !cost) return alert('Ingrese Nombre y Costo');
        tempRooms.push({ name, cap: parseInt(cap)||2, cost: parseFloat(cost) });
        document.getElementById('r-name').value = ''; document.getElementById('r-cap').value = ''; document.getElementById('r-cost').value = '';
        renderTempRooms();
    }
    function removeTempRoom(idx) { tempRooms.splice(idx, 1); renderTempRooms(); }
    function renderTempRooms() {
        const div = document.getElementById('temp-room-list'); div.innerHTML = '';
        tempRooms.forEach((r, idx) => {
            div.innerHTML += `<div class="room-list-item"><span><strong>${r.name}</strong> <span class="room-tag"><i class="fas fa-users"></i> ${r.cap}</span></span><span>S/ ${r.cost} <i class="fas fa-times" style="color:red; cursor:pointer; margin-left:10px;" onclick="removeTempRoom(${idx})"></i></span></div>`;
        });
    }

    function saveCatalogItem(e){
        e.preventDefault();
        const id = document.getElementById('cat-id').value;
        const type = document.getElementById('cat-type').value;
        const item = { id: id ? parseInt(id) : Date.now(), type, name: document.getElementById('cat-name').value };

        if(type === 'tour') { item.cost = parseFloat(document.getElementById('cat-cost').value)||0; } 
        else {
            if(tempRooms.length === 0) return alert('Debe agregar habitaciones');
            item.rooms = [...tempRooms];
        }
        
        const list = type==='tour'?db.tours:db.hotels;
        if(id) { const idx = list.findIndex(x=>x.id==id); if(idx!==-1) list[idx]=item; } 
        else list.push(item);
        
        saveDB(); resetCatForm(); renderCatalog(); updateSelects();
    }

    function editItem(type, id) {
        const item = (type==='tour'?db.tours:db.hotels).find(x=>x.id==id); if(!item) return;
        document.getElementById('cat-id').value = item.id;
        document.getElementById('cat-type').value = item.type;
        document.getElementById('cat-name').value = item.name;
        toggleCatFields();
        if(type==='tour') document.getElementById('cat-cost').value = item.cost;
        else { tempRooms = item.rooms ? [...item.rooms] : []; renderTempRooms(); }
        document.getElementById('cat-title').innerHTML = '<i class="fas fa-edit"></i> Editar Ítem';
        document.getElementById('btn-save-cat').innerText = "Actualizar";
        document.getElementById('btn-cancel-edit').style.display='inline-block';
        document.getElementById('view-catalog').scrollIntoView();
    }

    function resetCatForm(){
        document.querySelector('form').reset(); document.getElementById('cat-id').value=''; tempRooms = []; renderTempRooms();
        document.getElementById('cat-title').innerHTML='<i class="fas fa-plus-circle"></i> Nuevo Ítem';
        document.getElementById('btn-save-cat').innerText='Guardar'; document.getElementById('btn-cancel-edit').style.display='none';
    }

    // === BUSCADOR CATALOGO ===
    function renderCatalog(){
        const term = document.getElementById('cat-search').value.toLowerCase();
        const div = document.getElementById('catalog-list'); div.innerHTML='';
        
        // Unir listas y filtrar
        const allItems = [...db.tours, ...db.hotels].filter(i => i.name.toLowerCase().includes(term));
        
        allItems.forEach(i=>{
            let extra = i.type==='tour' ? `S/ ${i.cost}` : `${i.rooms.length} tipos de hab.`;
            div.innerHTML+=`
            <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div><strong>${i.name}</strong> <small>(${i.type}) - ${extra}</small></div>
                <div>
                    <button class="btn btn-sm btn-warning" onclick="editItem('${i.type}',${i.id})"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="delItem('${i.type}',${i.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        });
    }
    function delItem(t,id){ if(confirm('Borrar?')){ if(t==='tour')db.tours=db.tours.filter(x=>x.id!==id); else db.hotels=db.hotels.filter(x=>x.id!==id); saveDB(); renderCatalog(); updateSelects(); }}

    // === COTIZADOR ===
    function getTourOpt(){ let h='<option value="">-- Seleccionar --</option>'; db.tours.forEach(t=>h+=`<option value="${t.id}" data-cost="${t.cost}">${t.name}</option>`); return h; }
    function getHotelOpt(){ let h='<option value="">-- Seleccionar --</option>'; db.hotels.forEach(t=>h+=`<option value="${t.id}">${t.name}</option>`); return h; }
    function updateSelects(){ document.querySelectorAll('.dynamic').forEach(s=>{ let v=s.value; s.innerHTML = s.dataset.type==='tour' ? getTourOpt() : getHotelOpt(); s.value=v; }); }

    function addTourRow(d=null){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><select class="dynamic no-icon" data-type="tour" onchange="fillT(this)">${getTourOpt()}</select></td>
        <td><input type="number" class="cost no-icon" oninput="calc(this)"></td>
        <td><div class="control-group"><input type="number" class="mv" value="20" oninput="calc(this)"><select class="mt" onchange="calc(this)"><option value="%">%</option><option value="$">$</option></select></div></td>
        <td class="sub" style="font-weight:bold;">0.00</td><td><button class="btn btn-sm btn-danger" onclick="delRow(this)">X</button></td>`;
        document.querySelector('#tbl-tours tbody').appendChild(tr);
        if(d){ tr.querySelector('select').value=d.id; tr.querySelector('.cost').value=d.cost; tr.querySelector('.mv').value=d.mv; calc(tr.querySelector('select')); }
    }
    function fillT(e){ const o=e.options[e.selectedIndex]; if(o.value) e.closest('tr').querySelector('.cost').value=o.dataset.cost; calc(e); }

    function addHotelRow(d=null){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><select class="dynamic no-icon" data-type="hotel" onchange="loadRooms(this)">${getHotelOpt()}</select><select class="room-select no-icon" style="margin-top:5px; display:none; background:#f0f8ff;" onchange="fillRoomCost(this)"></select></td>
        <td><input type="number" class="qty no-icon" value="1" oninput="calc(this)"></td><td><input type="number" class="cost no-icon" oninput="calc(this)"></td>
        <td><div class="control-group"><input type="number" class="mv" value="20" oninput="calc(this)"><select class="mt" onchange="calc(this)"><option value="%">%</option><option value="$">$</option></select></div></td>
        <td class="sub" style="font-weight:bold;">0.00</td><td><button class="btn btn-sm btn-danger" onclick="delRow(this)">X</button></td>`;
        document.querySelector('#tbl-hotels tbody').appendChild(tr);
        if(d){ const hSel = tr.querySelector('.dynamic'); hSel.value = d.id; loadRooms(hSel, d.rid); tr.querySelector('.qty').value=d.q; tr.querySelector('.cost').value=d.cost; tr.querySelector('.mv').value=d.mv; calc(hSel); }
    }
    function loadRooms(sel, savedRoomName=null) {
        const hotelId = sel.value;
        const hotel = db.hotels.find(x => x.id == hotelId);
        const roomSel = sel.closest('tr').querySelector('.room-select');
        roomSel.innerHTML = '<option value="">-- Habitación --</option>';
        if(hotel && hotel.rooms) {
            hotel.rooms.forEach(r => { roomSel.innerHTML += `<option value="${r.name}" data-cost="${r.cost}">${r.name} (Cap: ${r.cap})</option>`; });
            roomSel.style.display = 'block';
            if(savedRoomName) roomSel.value = savedRoomName;
        } else { roomSel.style.display = 'none'; }
    }
    function fillRoomCost(sel) { const opt = sel.options[sel.selectedIndex]; if(opt.value) { sel.closest('tr').querySelector('.cost').value = opt.dataset.cost; calc(sel); } }

    function calc(e){
        const tr=e.closest('tr');
        const cost=parseFloat(tr.querySelector('.cost').value)||0;
        const mv=parseFloat(tr.querySelector('.mv').value)||0;
        const mt=tr.querySelector('.mt').value;
        const pax=parseFloat(document.getElementById('q-pax').value)||1;
        
        let prof = mt==='%' ? cost*(mv/100) : mv;
        let unit = cost+prof;
        let sub = tr.closest('table').id.includes('tour') ? unit*pax : unit*(parseFloat(tr.querySelector('.qty').value)||1);
        tr.querySelector('.sub').innerText=sub.toFixed(2);
        recalcAll();
    }
    
    // === CÁLCULO TOTAL, COSTO Y GANANCIA ===
    function recalcAll(){
        let totalVenta = 0;
        let totalCosto = 0;
        const pax = parseFloat(document.getElementById('q-pax').value)||1;

        // Calcular Tours
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr => {
            // Venta
            totalVenta += parseFloat(tr.querySelector('.sub').innerText)||0;
            // Costo (Costo Unitario * Pax)
            const costoUnit = parseFloat(tr.querySelector('.cost').value)||0;
            totalCosto += (costoUnit * pax);
        });

        // Calcular Hoteles
        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr => {
            // Venta
            totalVenta += parseFloat(tr.querySelector('.sub').innerText)||0;
            // Costo (Costo Unitario * Cantidad/Noches)
            const costoUnit = parseFloat(tr.querySelector('.cost').value)||0;
            const qty = parseFloat(tr.querySelector('.qty').value)||1;
            totalCosto += (costoUnit * qty);
        });

        const paid = parseFloat(document.getElementById('q-payment').value)||0;
        const cur = document.getElementById('q-currency').value;
        const ganancia = totalVenta - totalCosto;

        // Actualizar UI
        document.getElementById('disp-total').innerText = cur + ' ' + totalVenta.toFixed(2);
        document.getElementById('disp-balance').innerText = cur + ' ' + (totalVenta - paid).toFixed(2);
        
        // Nuevos campos
        document.getElementById('disp-cost').innerText = cur + ' ' + totalCosto.toFixed(2);
        document.getElementById('disp-profit').innerText = cur + ' ' + ganancia.toFixed(2);
    }

    function delRow(b){ b.closest('tr').remove(); recalcAll(); }
    
    // === HISTORIAL (BUSCADOR AVANZADO DE FECHAS) ===
    function filterHistory() {
        const text = document.getElementById('hist-search-text').value.toLowerCase();
        const start = document.getElementById('hist-date-start').value;
        const end = document.getElementById('hist-date-end').value;

        const filtered = db.quotes.filter(q => {
            const matchName = q.client.toLowerCase().includes(text);
            let matchDate = true;

            if (start || end) {
                const parts = q.date.split('/'); 
                const qDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); 
                
                if (start) {
                    const sDate = new Date(start);
                    sDate.setHours(0,0,0,0); qDate.setHours(0,0,0,0);
                    if (qDate < sDate) matchDate = false;
                }
                if (end && matchDate) {
                    const eDate = new Date(end);
                    eDate.setHours(0,0,0,0); qDate.setHours(0,0,0,0);
                    if (qDate > eDate) matchDate = false;
                }
            }
            return matchName && matchDate;
        });
        renderHistoryList(filtered);
    }

    function renderHistoryList(list) {
        const tb=document.getElementById('history-list'); tb.innerHTML='';
        list.slice().reverse().forEach(q=>{
            tb.innerHTML+=`<tr><td>${q.date}</td><td><strong>${q.client}</strong></td><td>${q.total}</td><td>${q.status||'Pend'}</td><td><button class="btn btn-sm btn-primary" onclick="loadQuote(${q.id})"><i class="fas fa-eye"></i></button> <button class="btn btn-sm btn-danger" onclick="delQuote(${q.id})"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }

    function saveQuote(){
        const q = {
            id: Date.now(), date: new Date().toLocaleDateString(),
            client: document.getElementById('q-client').value,
            total: document.getElementById('disp-total').innerText,
            data: {
                pax: document.getElementById('q-pax').value, cur: document.getElementById('q-currency').value,
                agent: document.getElementById('q-agent').value, in: document.getElementById('q-in').value, out: document.getElementById('q-out').value,
                paid: document.getElementById('q-payment').value,
                tours:[], hotels:[]
            }
        };
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr=>q.data.tours.push({id:tr.querySelector('select').value, cost:tr.querySelector('.cost').value, mv:tr.querySelector('.mv').value, mt:tr.querySelector('.mt').value}));
        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr=>q.data.hotels.push({id:tr.querySelector('.dynamic').value, rid:tr.querySelector('.room-select').value, q:tr.querySelector('.qty').value, cost:tr.querySelector('.cost').value, mv:tr.querySelector('.mv').value, mt:tr.querySelector('.mt').value}));
        db.quotes.push(q); saveDB(); filterHistory(); alert('Guardado');
    }
    function delQuote(id){ if(confirm('Eliminar?')){ db.quotes=db.quotes.filter(x=>x.id!==id); saveDB(); filterHistory(); } }
    function loadQuote(id){
        const q=db.quotes.find(x=>x.id===id); if(!q)return;
        document.getElementById('q-client').value=q.client; document.getElementById('q-pax').value=q.data.pax;
        document.getElementById('q-currency').value=q.data.cur; document.getElementById('q-agent').value=q.data.agent||'';
        document.getElementById('q-payment').value=q.data.paid||0;
        document.getElementById('q-in').value=q.data.in; document.getElementById('q-out').value=q.data.out;
        
        document.querySelector('#tbl-tours tbody').innerHTML=''; q.data.tours.forEach(t=>addTourRow(t));
        document.querySelector('#tbl-hotels tbody').innerHTML=''; q.data.hotels.forEach(h=>addHotelRow(h));
        recalcAll(); switchView('quote');
    }

    // === GENERAR PDF (MODIFICADO: Sin precios detallados) ===
    function generatePDF(){
        const cur = document.getElementById('q-currency').value;
        const tot = document.getElementById('disp-total').innerText.split(' ')[1];
        const pay = parseFloat(document.getElementById('q-payment').value).toFixed(2);
        
        document.getElementById('pdf-date').innerText=new Date().toLocaleDateString();
        document.getElementById('pdf-agent').innerText=document.getElementById('q-agent').value;
        document.getElementById('pdf-client').innerText=document.getElementById('q-client').value;
        document.getElementById('pdf-pax').innerText=document.getElementById('q-pax').value;
        document.getElementById('pdf-in').innerText=document.getElementById('q-in').value;
        document.getElementById('pdf-out').innerText=document.getElementById('q-out').value;

        // Construir tabla sin columna de precios
        let h = '<table class="pdf-table"><thead><tr><th style="border-bottom:2px solid #333; padding-bottom:5px;">DESCRIPCIÓN DE SERVICIOS</th></tr></thead><tbody>';
        
        // Tours
        document.querySelectorAll('#tbl-tours tbody tr').forEach(tr=>{
            const sel = tr.querySelector('select');
            if(sel.selectedIndex > -1) {
                const txt = sel.options[sel.selectedIndex].text;
                if(txt !== '-- Seleccionar --') {
                    h+=`<tr><td style="padding:10px 5px;">• Tour: ${txt}</td></tr>`;
                }
            }
        });
        
        // Hoteles
        document.querySelectorAll('#tbl-hotels tbody tr').forEach(tr=>{
            const sel = tr.querySelector('.dynamic');
            const rm = tr.querySelector('.room-select').value;
            if(sel.selectedIndex > -1) {
                const txt = sel.options[sel.selectedIndex].text;
                if(txt !== '-- Seleccionar --') {
                     const noches = tr.querySelector('.qty').value;
                    h+=`<tr><td style="padding:10px 5px;">• Alojamiento: ${txt} - ${rm} (${noches} noches/und)</td></tr>`;
                }
            }
        });
        h+='</tbody></table>';
        document.getElementById('pdf-body').innerHTML=h;
        
        document.getElementById('pdf-total').innerText=cur+' '+tot;
        document.getElementById('pdf-paid').innerText=cur+' '+pay;
        document.getElementById('pdf-bal').innerText=cur+' '+(tot-pay).toFixed(2);

        const el=document.getElementById('pdf-content');
        html2pdf().set({ margin:0, filename:`Coti_${document.getElementById('q-client').value}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'pt',format:'a4'} }).from(el).save();
    }

    function switchView(v){
        document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        if(v=='quote') { document.querySelector('.nav-menu button:nth-child(1)').classList.add('active'); document.getElementById('finance-bar').style.display='flex'; }
        if(v=='dashboard') { document.querySelector('.nav-menu button:nth-child(2)').classList.add('active'); filterHistory(); document.getElementById('finance-bar').style.display='none'; }
        if(v=='catalog') { document.querySelector('.nav-menu button:nth-child(3)').classList.add('active'); document.getElementById('finance-bar').style.display='none'; }
    }
    
    function resetQuote(){ document.querySelectorAll('#view-quote input').forEach(i=>i.value=''); document.querySelector('#tbl-tours tbody').innerHTML=''; document.querySelector('#tbl-hotels tbody').innerHTML=''; recalcAll(); }

    renderCatalog(); filterHistory();
</script>
</body>
</html>
